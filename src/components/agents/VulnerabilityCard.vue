<template>
    <div class="vulnerability-card" :class="`severity-${vulnerability.severity}`" @click="showDialog = true">
        <div class="severity">{{ vulnerability.severity }}</div>
        <div class="wrapper">
            <div class="title">
                <span>{{ vulnerability.title }}</span>
            </div>
            <div class="property" aria-label="Detection time" data-balloon-pos="up" data-balloon-length="medium">
                <i class="mdi mdi-clock-outline"></i>
                <span>{{ detectionTime }}</span>
            </div>
            <div
                class="property"
                :aria-label="`CVSS2: ${vulnerability.cvss2_score} - CVSS3: ${vulnerability.cvss3_score}`"
                data-balloon-pos="up"
                data-balloon-length="medium"
            >
                <i class="mdi mdi-counter"></i>
                <span>{{ vulnerability.cve }}</span>
            </div>
            <div class="property" :aria-label="`Version: ${vulnerability.version}`" data-balloon-pos="up" data-balloon-length="medium">
                <i class="mdi mdi-crosshairs-question"></i>
                <span>{{ vulnerability.name }}</span>
            </div>
        </div>
    </div>
    <el-dialog :show-close="true" class="vulnerability-dialog" v-model="showDialog" width="90%" append-to-body>
        <div class="vulnerability-property-group" v-if="vulnerabilitySanitized">
            <div class="prop" v-for="item of vulnerabilitySanitized" :key="item.label">
                <div class="value">{{ item.value ?? "-" }}</div>
                <div class="label">{{ item.label }}</div>
            </div>
        </div>
        <div class="vulnerability-references">
            <div class="title">External references</div>
            <ul class="list">
                <li v-for="ref of vulnerability.external_references" :key="ref">
                    <a :href="ref" target="_blank">{{ ref }}</a>
                </li>
            </ul>
        </div>
    </el-dialog>
</template>

<script setup lang="ts">
import { computed, ref, toRefs } from "vue"
import { AgentVulnerabilities } from "@/types/agents.d"
import dayjs from "dayjs"
import { cloneDeep } from "lodash"

const props = defineProps<{
    vulnerability: AgentVulnerabilities
}>()
const { vulnerability } = toRefs(props)

const vulnerabilitySanitized = computed(() => {
    const newObj = []
    const obj = cloneDeep(vulnerability.value)
    for (const k in obj) {
        if (typeof obj[k] === "string") {
            const maybeTime = dayjs(obj[k])
            if (maybeTime.isValid()) {
                obj[k] = maybeTime.format("DD/MM/YYYY @ HH:mm")
            }
        }

        if (!["external_references", "id"].includes(k))
            newObj.push({
                label: k,
                value: obj[k]
            })
    }
    return newObj
})

const detectionTime = computed(() => {
    const detection_time = dayjs(vulnerability.value.detection_time)
    if (!detection_time.isValid()) return vulnerability.value.detection_time

    return detection_time.format("DD/MM/YYYY @ HH:mm")
})

const showDialog = ref(false)
</script>

<style lang="scss" scoped>
@import "@/assets/scss/_variables";
@import "@/assets/scss/card-shadow";

.vulnerability-card {
    @extend .card-base;
    overflow: visible;
    border: 2px solid #e3e8ec;
    max-width: 100%;
    box-sizing: border-box;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;

    .severity {
        position: absolute;
        top: -9px;
        left: var(--size-2);
        color: white;
        border-radius: 6px;
        line-height: 1;
        background-color: #c4d0dc;
        text-transform: uppercase;
        font-family: var(--font-mono);
        font-size: var(--font-size-0);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 3px var(--size-2);
    }

    .wrapper {
        padding: var(--size-3) calc(var(--size-2) + 2px);

        .title {
            font-weight: bold;
            line-height: 1.2;
            margin-bottom: 10px;
        }

        .property {
            font-size: 13px;
            margin-bottom: 2px;

            i {
                margin-right: 5px;
            }
        }
    }

    &.severity-Critical {
        border-color: $text-color-danger;
        .severity {
            background-color: $text-color-danger;
        }
    }
    &.severity-High {
        border-color: $text-color-danger;
        .severity {
            background-color: $text-color-danger;
        }
    }
    &.severity-Low {
    }
    &.severity-Medium {
        border-color: $text-color-warning;
        .severity {
            background-color: $text-color-warning;
        }
    }
    &.severity-Untriaged {
    }
}

.vulnerability-property-group {
    width: 100%;
    display: grid;
    box-sizing: border-box;
    padding: var(--size-2) var(--size-4);
    grid-gap: var(--size-5);
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    grid-auto-flow: row dense;

    .prop {
        .value {
            font-weight: bold;
            margin-bottom: 2px;
            white-space: nowrap;
        }
        .label {
            font-size: var(--font-size-0);
            font-family: var(--font-mono);
            opacity: 0.8;
        }
    }
}

.vulnerability-references {
    padding: 0 var(--size-4);
    padding-top: var(--size-4);
    overflow: hidden;

    .list {
        padding-left: 16px;

        li {
            word-break: break-all;
        }
    }
}
</style>
