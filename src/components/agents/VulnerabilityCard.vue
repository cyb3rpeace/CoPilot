<template>
	<div class="vulnerability-card" :class="`severity-${vulnerability.severity}`" @click="showDialog = true">
		<div class="severity">{{ vulnerability.severity }}</div>
		<div class="wrapper">
			<div class="title">
				<span>{{ vulnerability.title }}</span>
			</div>
			<div class="property" aria-label="Detection time" data-balloon-pos="up" data-balloon-length="medium">
				<n-icon><ClockIcon /></n-icon>
				<span>{{ detectionTime }}</span>
			</div>
			<div
				class="property"
				:aria-label="`CVSS2: ${vulnerability.cvss2_score} - CVSS3: ${vulnerability.cvss3_score}`"
				data-balloon-pos="up"
				data-balloon-length="medium"
			>
				<n-icon><CounterIcon /></n-icon>
				<span>{{ vulnerability.cve }}</span>
			</div>
			<div
				class="property"
				:aria-label="`Version: ${vulnerability.version}`"
				data-balloon-pos="up"
				data-balloon-length="medium"
			>
				<n-icon><VulnerabilityIcon /></n-icon>
				<span>{{ vulnerability.name }}</span>
			</div>
		</div>
	</div>
	<n-modal :show-close="true" class="vulnerability-dialog" v-model:show="showDialog">
		<div class="vulnerability-property-group" v-if="vulnerabilitySanitized">
			<div class="prop" v-for="item of vulnerabilitySanitized" :key="item.label">
				<div class="value">{{ item.value ?? "-" }}</div>
				<div class="label">{{ item.label }}</div>
			</div>
		</div>
		<div class="vulnerability-references">
			<div class="title">External references</div>
			<ul class="list">
				<li v-for="ref of vulnerability.external_references" :key="ref">
					<a :href="ref" target="_blank">{{ ref }}</a>
				</li>
			</ul>
		</div>
	</n-modal>
</template>

<script setup lang="ts">
import { computed, ref, toRefs } from "vue"
import { type AgentVulnerabilities } from "@/types/agents.d"
import dayjs from "dayjs"
import { cloneDeep } from "lodash"
import { NModal, NIcon } from "naive-ui"
import ClockIcon from "@vicons/carbon/Time"
import CounterIcon from "@vicons/material/ScoreboardOutlined"
import VulnerabilityIcon from "@vicons/material/CrisisAlertTwotone"

const props = defineProps<{
	vulnerability: AgentVulnerabilities
}>()
const { vulnerability } = toRefs(props)

const vulnerabilitySanitized = computed(() => {
	const newObj = []
	const obj: { [key: string]: any } = cloneDeep(vulnerability.value)
	for (const k in obj) {
		if (typeof obj[k] === "string") {
			const maybeTime = dayjs(obj[k])
			if (maybeTime.isValid()) {
				obj[k] = maybeTime.format("DD/MM/YYYY @ HH:mm")
			}
		}

		if (!["external_references", "id"].includes(k))
			newObj.push({
				label: k,
				value: obj[k]
			})
	}
	return newObj
})

const detectionTime = computed(() => {
	const detection_time = dayjs(vulnerability.value.detection_time)
	if (!detection_time.isValid()) return vulnerability.value.detection_time

	return detection_time.format("DD/MM/YYYY @ HH:mm")
})

const showDialog = ref(false)
</script>

<style lang="scss" scoped>
.vulnerability-card {
	overflow: visible;
	border: 2px solid #e3e8ec;
	max-width: 100%;
	box-sizing: border-box;
	transition: all 0.3s;
	cursor: pointer;
	position: relative;

	.severity {
		position: absolute;
		top: -9px;
		left: var(--size-2);
		color: white;
		border-radius: 6px;
		line-height: 1;
		background-color: #c4d0dc;
		text-transform: uppercase;
		font-family: var(--font-family-mono);
		@apply text-xs;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		padding: 3px var(--size-2);
	}

	.wrapper {
		padding: var(--size-3) calc(var(--size-2) + 2px);

		.title {
			font-weight: bold;
			line-height: 1.2;
			margin-bottom: 10px;
		}

		.property {
			font-size: 13px;
			margin-bottom: 2px;

			i {
				margin-right: 5px;
			}
		}
	}

	&.severity-Critical {
		border-color: var(--error-color);
		.severity {
			background-color: var(--error-color);
		}
	}
	&.severity-High {
		border-color: var(--error-color);
		.severity {
			background-color: var(--error-color);
		}
	}
	&.severity-Low {
	}
	&.severity-Medium {
		border-color: var(--warning-color);
		.severity {
			background-color: var(--warning-color);
		}
	}
	&.severity-Untriaged {
	}
}

.vulnerability-property-group {
	width: 100%;
	display: grid;
	box-sizing: border-box;
	padding: var(--size-2) var(--size-4);
	grid-gap: var(--size-5);
	grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	grid-auto-flow: row dense;

	.prop {
		.value {
			font-weight: bold;
			margin-bottom: 2px;
			white-space: nowrap;
		}
		.label {
			@apply text-xs;
			font-family: var(--font-family-mono);
			opacity: 0.8;
		}
	}
}

.vulnerability-references {
	padding: 0 var(--size-4);
	padding-top: var(--size-4);
	overflow: hidden;

	.list {
		padding-left: 16px;

		li {
			word-break: break-all;
		}
	}
}
</style>
